<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <link rel="icon" type="image/x-icon" href="https://www2.0zz0.com/2024/11/17/11/646664920.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>علاج الأعراض الجانبية</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #3b82f6;
            --accent-color: #f43f5e;
            --success-color: #22c55e;
            --background-color: #f1f5f9;
        }

        * {
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--background-color);
            min-height: 100vh;
            padding: 20px;
        }

        .treatment-container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .treatment-header {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            padding: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .treatment-header h1 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5em;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-3px);
        }

        .treatment-content {
            padding: 20px;
        }

        .ai-response {
            padding: 30px;
            line-height: 1.8;
            font-size: 1.1em;
            color: #1e293b;
        }

        .highlight-danger {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #ef4444;
            font-weight: 600;
            padding: 4px 12px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
            margin: 4px 0;
        }

        .highlight-danger::before {
            content: "\f071";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
        }

        .highlight-warning {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #f59e0b;
            font-weight: 600;
            padding: 4px 12px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 6px;
            margin: 4px 0;
        }

        .highlight-warning::before {
            content: "\f06a";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
        }

        .highlight-success {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #10b981;
            font-weight: 600;
            padding: 4px 12px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 6px;
            margin: 4px 0;
        }

        .highlight-success::before {
            content: "\f058";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
        }

        .treatment-list {
            margin: 15px 0;
            padding-right: 20px;
        }

        .treatment-item {
            position: relative;
            padding: 12px 40px 12px 15px;
            margin: 10px 0;
            background: #f8fafc;
            border-radius: 8px;
            border-right: 4px solid #3b82f6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .treatment-item::before {
            content: "\f054";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            right: 15px;
            color: #3b82f6;
        }

        #loadingIndicator {
            text-align: center;
            padding: 40px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.1em;
        }

        #loadingIndicator::before {
            content: "";
            width: 25px;
            height: 25px;
            border: 3px solid #ddd;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .section-title {
            color: var(--primary-color);
            font-size: 1.3em;
            margin: 25px 0 15px;
            padding-right: 15px;
            border-right: 4px solid var(--primary-color);
            background: linear-gradient(to left, rgba(37, 99, 235, 0.1), transparent);
            padding: 10px 15px;
            border-radius: 0 8px 8px 0;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .treatment-container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .treatment-header {
                padding: 20px;
            }
            
            .ai-response {
                padding: 20px;
                font-size: 1em;
            }
            
            .section-title {
                font-size: 1.2em;
                margin: 20px 0 12px;
            }
        }

        .error-message {
            background: rgba(244, 63, 94, 0.1);
            color: var(--accent-color);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 20px;
        }

        .response-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin: 25px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .retry-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(244, 63, 94, 0.2);
        }

        .retry-btn:hover {
            background: #e11d48;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(244, 63, 94, 0.3);
        }

        .retry-btn i {
            font-size: 0.9em;
        }

        .nav-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
        }

        .nav-btn:hover:not(:disabled) {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3);
        }

        .nav-btn:disabled {
            background: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .nav-btn i {
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .response-controls {
                flex-direction: column;
                gap: 10px;
                padding: 12px;
            }

            .retry-btn, .nav-btn {
                width: 100%;
                justify-content: center;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="treatment-container">
        <div class="treatment-header">
            <h1><i class="fas fa-notes-medical"></i> علاج الأعراض الجانبية</h1>
            <button onclick="window.location.href='side-effects.html'" class="back-btn">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
        </div>
        
        <div class="treatment-content">
            <div id="loadingIndicator" style="display: none;">
                جاري تحليل العرض وإعداد التوصيات...
            </div>
            <div id="aiResponse" class="ai-response"></div>
            <div class="response-controls">
                <button id="retryBtn" class="retry-btn" onclick="retryTreatmentRecommendation()">
                    <i class="fas fa-redo"></i> إعادة الإجابة
                </button>
                <button id="prevResponseBtn" class="nav-btn" onclick="navigateResponse(-1)" disabled>
                    <i class="fas fa-arrow-left"></i> السابق
                </button>
                <button id="nextResponseBtn" class="nav-btn" onclick="navigateResponse(1)" disabled>
                    التالي <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        const environment = {
            gemini_api_key: 'AIzaSyADaEiVHPCdmuFzSYDLBiS4ab0M3WISIF8'
        };
        const firebaseConfig = {
            apiKey: "AIzaSyAYMRiJQs8vsapzX1bMHTWjrEb-N2ePIPo",
            authDomain: "mhd-vaxtracker.firebaseapp.com",
            databaseURL: "https://mhd-vaxtracker-default-rtdb.firebaseio.com",
            projectId: "mhd-vaxtracker",
            storageBucket: "mhd-vaxtracker.firebasestorage.app",
            messagingSenderId: "104907445114",
            appId: "1:104907445114:web:6110c5cf4e2607ed677cc3",
            measurementId: "G-RF9SYJ2KCH"
        };
        
        // تهيئة Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        let currentResponseIndex = 0;
        let responses = [];

        async function retryTreatmentRecommendation() {
            document.getElementById('loadingIndicator').style.display = 'flex';
            document.getElementById('aiResponse').innerHTML = '';

            const params = new URLSearchParams(window.location.search);
            const symptom = params.get('symptom');
            const vaccineId = params.get('vaccine');
            const nationalId = localStorage.getItem('nationalId');

            try {
                const userData = JSON.parse(localStorage.getItem('userData'));
                const prompt = `
                    أنت مساعد طبي متخصص في علاج الأعراض الجانبية للتطعيمات.
                    لو المستخدم قالك عرض جانبي هزار او حاجه ملهاش عازه قوله دا غير حقيقي ولو صح كان عرض جانبي كمل 
                    يرجى تقديم المعلومات باللغة العربية وباستخدام التنسيق التالي:

                    معلومات الطفل:
                    - الاسم: ${userData.name}
                    - تاريخ الميلاد: ${userData.birthdate}
                    - العرض: ${symptom}
                    - نوع التطعيم: ${getVaccineName(vaccineId)}

                    المطلوب تقديم النصائح والإرشادات التالية:

                    ###تقييم مستوى خطورة العرض###
                    - قم بتقييم خورة العرض بناءً على نوع التطعيم والعمر

                    ###نصائح للتعامل مع العرض في المنزل###
                    - قدم نصائح عملية للتعامل مع العرض
                    - اذكر الأدوية المنزلية المناسبة إن وجدت

                    ###متى يجب استشارة الطبيب فوراً###
                    - اذكر الحالات التي تستدعي زيارة الطبيب فوراً
                    - اذكر العلامات التي تستدعي زيارة الطبب فوراً
                    - اذكر الأعراض الخطيرة التي تتطلب رعاية طبية عاجلة

                    ###إرشادات وقائية###
                    - قدم إرشادات لتجنب تفاقم العرض
                    - اذكر الممارسات التي يجب تجنبها

                    واخر حاجه دا طفل وحاول متقولش له مريض 

                    
                `;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${environment.gemini_api_key}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('فشل في الاتصال بخدمة المعالجة');
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                    throw new Error('لم يتم العثور على إجابة مناسبة');
                }

                const newAnswer = data.candidates[0].content.parts[0].text;

                // تخزين الإجابة الجديدة في Firebase
                await firebase.database().ref(`users/${nationalId}/treatments/${vaccineId}/${encodeURIComponent(symptom)}/responses`).push({
                    answer: newAnswer,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                responses.push(newAnswer);
                currentResponseIndex = responses.length - 1;
                updateResponseDisplay();

            } catch (error) {
                console.error('خطأ:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('aiResponse').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        عذراً، حدث خطأ: ${error.message}
                    </div>
                `;
            }
        }

        function navigateResponse(direction) {
            currentResponseIndex += direction;
            updateResponseDisplay();
        }

        function updateResponseDisplay() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('aiResponse').innerHTML = formatResponse(responses[currentResponseIndex]);
            document.getElementById('prevResponseBtn').disabled = currentResponseIndex === 0;
            document.getElementById('nextResponseBtn').disabled = currentResponseIndex === responses.length - 1;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const symptom = params.get('symptom');
            const vaccineId = params.get('vaccine');
            const nationalId = localStorage.getItem('nationalId');

            try {
                // تحميل الإجابات المخزنة
                const responseSnapshot = await firebase.database()
                    .ref(`users/${nationalId}/treatments/${vaccineId}/${encodeURIComponent(symptom)}/responses`)
                    .once('value');

                if (responseSnapshot.exists()) {
                    responses = Object.values(responseSnapshot.val()).map(entry => entry.answer);
                    currentResponseIndex = responses.length - 1;
                    updateResponseDisplay();
                } else {
                    // إذا لم توجد إجابات سابقة، اطلب إجابة جديدة
                    await retryTreatmentRecommendation();
                }
            } catch (error) {
                console.error('خطأ:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('aiResponse').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        عذراً، حدث خطأ: ${error.message}
                    </div>
                `;
            }
        });

        function getVaccineName(vaccineId) {
            const vaccineNames = {
                'bcg1': "التطعيم ضد الدرن (BCG)",
                'hepb1': "التطعيم ضد التهاب الكبد الوبائي ب (الجرعة الأولى)",
                'dtp1': "التطعيم ضد الدفتيريا والتيتانوس والسعال الديكي (الجرعة الأولى)",
                'polio1': "التطعيم ضد شلل الأطفال (الجرعة الأولى)",
                'hib1': "التطعيم ضد المستدمية النزلية (الجرعة الأولى)",
                'hepb2': "التطعيم ضد التهاب الكبد الوبائي (الجرعة الثانية)",
                'pcv1': "التطعيم ضد الالتهاب الرئوي (الجرعة الأولى)",
                'rota1': "التطعيم ضد فيروس الروتا (الجرعة الأولى)",
                'dtp2': "التطعيم ضد الدفتيريا والتيتانوس والسعال الديكي (الجرعة الثانية)",
                'polio2': "التطعيم ضد شلل الأطفال (الجرعة الثانية)",
                'hib2': "التطعيم ضد المستدمية النزلية (الجرعة الثانية)",
                'pcv2': "التطعيم ضد الالتهاب الرئوي (الجرعة الثانية)",
                'rota2': "التطعيم ضد فيروس الروتا (الجرعة الثانية)",
                'dtp3': "التطعيم ضد الدفتيريا والتيتانوس والسعال الديكي (الجرعة الثالثة)",
                'polio3': "التطعيم ضد شلل الأطفال (الجرعة الثالثة)",
                'hib3': "التطعيم ضد المستدمية النزلية (الجرعة الثالثة)",
                'pcv3': "التطعيم ضد الالتهاب الرئوي (الجرعة الثالثة)",
                'rota3': "التطعيم ضد فيروس الروتا (الجرعة الثالثة)",
                'mmr1': "التطعيم ضد الحصبة والنكاف والحصبة الألمانية (الجرعة الأولى)",
                'var1': "التطعيم ضد الجدري المائي (الجرعة الأولى)",
                'hepa1': "التطعيم ضد التها الكبد A (الجرعة الأولى)",
                'flu1': "التطعيم ضد الأنفلونزا",
                'mmr2': "التطعيم ضد الحصبة والنكاف والحصبة الألمانية (الجرعة اثانية)",
                'dtp4': "التطعيم ضد الدفتيريا والتيتانوس والسعال الديكي (جرعة تعزيزية)",
                'polio4': "التطعيم ضد شلل الأطفال (جرعة تعزيزية)",
                'flu2': "التطعيم ضد الأنفلونزا (إذا كان موسمياً)",
                'hepa2': "التطعيم ضد التهاب الكبد A (الجرعة الثانية)"
            };

            return vaccineNames[vaccineId] || "تطعيم غير معروف";
        }

        function formatResponse(text) {
            // تنظيف النص من العلامات الغير مرغوبة
            text = text.replace(/`/g, '');
            text = text.replace(/\\/g, '');
            
            // تنسيق العناوين
            text = text.replace(/###([^#]+)###/g, '<h2 class="section-title">$1</h2>');
            text = text.replace(/##([^#]+)##/g, '<h3 class="section-subtitle">$1</h3>');
            
            // تنسيق النصوص المميزة
            text = text.replace(/\*\*\*([^\*]+)\*\*\*/g, '<span class="highlight-danger">$1</span>');
            text = text.replace(/\*\*([^\*]+)\*\*/g, '<span class="highlight-warning">$1</span>');
            text = text.replace(/\*([^\*]+)\*/g, '<span class="highlight-success">$1</span>');
            
            // تحسين تنسيق القو�م
            text = text.replace(/(?:^|\n)- (.+)/g, '<div class="treatment-item">$1</div>');
            
            // تنسيق الفقرات
            text = text.split('\n\n').map(paragraph => 
                paragraph.trim() ? `<p>${paragraph}</p>` : ''
            ).join('');
            
            return `<div class="ai-content">${text}</div>`;
        }
    </script>
</body>
</html>