<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <link rel="icon" type="image/x-icon" href="https://www2.0zz0.com/2024/11/17/11/646664920.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المركز الصحي - نظام التطعيمات</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        // تهيئة EmailJS مع معرف المستخدم الخاص بك
        (function() {
            emailjs.init("JYT8xIeUJ9tdgMZCf"); // أدخل المفتاح العام الخاص بك هنا
        })();
    </script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --background-color: #f8fafc;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        body {
            background: var(--background-color);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(44, 62, 80, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(52, 152, 219, 0.1) 0%, transparent 20%);
            margin: 0;
            min-height: 100vh;
            padding: 20px;
            font-family: 'Cairo', sans-serif;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .search-section {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .search-section:hover {
            transform: translateY(-5px);
        }

        .search-section h1 {
            color: #333;
            font-size: 1.8em;
            margin: 20px 0 40px;
            position: relative;
            text-align: center;
        }

        .search-section h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 2px;
        }

        .search-form {
            display: flex;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        input {
            flex: 1;
            padding: 15px;
            padding-right: 45px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--background-color);
        }

        input:focus {
            border-color: var(--secondary-color);
            background: white;
            box-shadow: 0 0 0 5px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
        }

        .user-details {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }

        .vaccine-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            transition: var(--transition);
            border: 2px solid #eee;
        }

        .vaccine-card:hover {
            transform: translateY(-3px);
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 5px rgba(52, 152, 219, 0.1);
        }

        .confirm-btn {
            background: var(--success-color);
            padding: 12px 25px;
            border-radius: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-right: 4px solid var(--success-color);
        }

        .notification.error {
            border-right: 4px solid var(--accent-color);
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification i {
            font-size: 1.2em;
        }

        .notification.success i {
            color: var(--success-color);
        }

        .notification.error i {
            color: var(--accent-color);
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo i {
            font-size: 3.5em;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: float 3s ease-in-out infinite;
        }

        .input-wrapper {
            position: relative;
            flex: 1;
        }

        .input-wrapper i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            transition: color 0.3s ease;
        }

        .input-wrapper input:focus + i {
            color: var(--secondary-color);
        }

        .error-message {
            margin-top: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            background-color: rgba(231, 76, 60, 0.1);
            border-right: 3px solid var(--accent-color);
            color: var(--accent-color);
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .vaccine-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            border: 2px solid #eee;
        }

        .vaccine-card:hover {
            transform: translateY(-3px);
            border-color: var(--secondary-color);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.1);
        }

        .vaccine-info h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
        }

        .vaccine-date {
            color: #666;
            font-size: 0.9em;
        }

        .confirm-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        /* أنماط قسم التحقق */
        .verification-section {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .verification-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: slideUp 0.3s ease;
        }

        .question-box {
            margin: 20px 0;
            padding: 20px;
            background: var(--background-color);
            border-radius: 15px;
        }

        .question-text {
            font-size: 1.2em;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .options-container {
            display: grid;
            gap: 10px;
            margin-top: 20px;
        }

        .option-btn {
            padding: 15px 20px;
            border: 2px solid #eee;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            color: var(--primary-color);
        }

        .option-btn:hover {
            border-color: var(--secondary-color);
            background: var(--background-color);
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* أنماط قسم المحظورين */
        .blocked-users-section {
            margin: 20px auto;
            max-width: 800px;
        }

        .toggle-blocked-btn {
            background: var(--primary-color);
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
            transition: all 0.3s ease;
        }

        .toggle-blocked-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .blocked-users-container {
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
        }

        .blocked-users-list {
            display: grid;
            gap: 15px;
            margin-top: 15px;
        }

        .blocked-user-card {
            background: var(--background-color);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .blocked-user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .blocked-user-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .blocked-user-name {
            font-weight: bold;
            color: var(--primary-color);
        }

        .blocked-user-id {
            font-size: 0.9em;
            color: #666;
        }

        .request-access-btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .request-access-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
        }

        /* أنماط النافذة المنبثقة */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            animation: slideUp 0.3s ease;
        }

        .modal textarea {
            width: 100%;
            height: 100px;
            margin: 15px 0;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
            resize: vertical;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* تحسين أنماط الأزرار */
        .send-request-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .send-request-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(46, 204, 113, 0.3);
        }

        .send-request-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .cancel-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(231, 76, 60, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <i class="fas fa-hospital-user"></i>
            <h1>المركز الصحي للتط��يمات</h1>
        </div>

        <div class="search-section">
            <div class="search-form">
                <div class="input-wrapper">
                    <input type="text" id="nationalId" placeholder="أدخل الرقم القومي للمريض" maxlength="14">
                    <i class="fas fa-id-card"></i>
                </div>
                <button onclick="searchUser()" id="searchButton">
                    <span class="button-text">
                        <i class="fas fa-search"></i>
                        بحث
                    </span>
                    <span class="loading">
                        <i class="fas fa-spinner"></i>
                    </span>
                </button>
            </div>
            <div class="error-message" id="searchError"></div>
        </div>

        <div id="vaccinesSection" style="display: none;">
            <div class="user-details">
                <h2>معلومات المريض</h2>
                <p id="userName"><strong>الاسم:</strong> <span></span></p>
                <p id="userBirthDate"><strong>تاريخ الميلاد:</strong> <span></span></p>
            </div>

            <h2>التطعيمات المستحقة</h2>
            <div id="upcomingVaccines" class="vaccines-container"></div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <div id="verificationSection" class="verification-section" style="display: none;">
        <div class="verification-card">
            <h2>التحقق من الهوية</h2>
            <p>للتأكد من هويتك، يرجى الإجابة على السؤال التالي:</p>
            
            <div class="question-box">
                <p id="verificationQuestion" class="question-text"></p>
                <div class="options-container" id="optionsContainer">
                    <!-- سيتم إضافة الخيارات ديناميكياً -->
                </div>
            </div>

            <div class="error-message" id="verificationError"></div>
        </div>
    </div>

    <div class="blocked-users-section">
        <button onclick="toggleBlockedUsers()" class="toggle-blocked-btn">
            <i class="fas fa-ban"></i>
            عرض المستخدمين المحظورين
        </button>
        
        <div id="blockedUsersContainer" class="blocked-users-container" style="display: none;">
            <h3>المستخدمين المحظورين</h3>
            <div id="blockedUsersList" class="blocked-users-list">
                <!-- سيتم إضافة البطاقات ديناميكياً -->
            </div>
        </div>
    </div>

    <div id="requestAccessModal" class="modal">
        <div class="modal-content">
            <h3>طلب إعادة الوصول</h3>
            <p>سيتم إرسال طلب إعادة الوصول إلى المستخدم عبر البريد الإلكتروني</p>
            <textarea id="requestMessage" placeholder="اكتب رسالتك هنا (اختياري)"></textarea>
            <div class="modal-buttons">
                <button onclick="sendAccessRequest()" class="send-request-btn">
                    <i class="fas fa-paper-plane"></i>
                    إرسال الطلب
                </button>
                <button onclick="closeRequestModal()" class="cancel-btn">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAYMRiJQs8vsapzX1bMHTWjrEb-N2ePIPo",
            authDomain: "mhd-vaxtracker.firebaseapp.com",
            databaseURL: "https://mhd-vaxtracker-default-rtdb.firebaseio.com",
            projectId: "mhd-vaxtracker",
            storageBucket: "mhd-vaxtracker.firebasestorage.app",
            messagingSenderId: "104907445114",
            appId: "1:104907445114:web:6110c5cf4e2607ed677cc3",
            measurementId: "G-RF9SYJ2KCH"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // جدول التطعيمات
        const vaccineSchedule = {
            0: [ // عند الولادة
            { name: "التطعيم ضد الدرن (BCG)", id: "bcg1" },
            { name: "التطعيم ضد التهاب الكبد الوبائي ب (الجرعة الأولى)", id: "hepb1" }
        ],
        2: [ // شهرين
            { name: "التطعيم ضد الدفتيريا والتيتانوس والسعال الديكي (الجرعة اأولى)", id: "dtp1" },
            { name: "التطعيم ضد شلل الأطفال (لجرعة الأولى)", id: "polio1" },
            { name: "التطعيم ضد المستدمي النزلية (الجرعة الأولى)", id: "hib1" },
            { name: "التطعيم د التهاب لكبد الوبائي  (الجرعة الثانية)", id: "hepb2" },
            { name: "التطعيم ضد الالتهاب الرئوي (الجرعة الأولى)", id: "pcv1" },
            { name: "التطعيم ضد فيروس الروتا (الجرعة اأولى)", id: "rota1" }
        ],
        4: [ // 4 شهور
            { name: "التطعيم ضد الدفتيريا والتيتانوس والسعال الديكي (الجرعة الثانية)", id: "dtp2" },
            { name: "التطعيم ضد شلل الأطفل (الجرعة الثانية)", id: "polio2" },
            { name: "التطعيم ضد المستدمية النزلية (الجرعة الثانية)", id: "hib2" },
            { name: "التطعيم ضد الالتهاب الرئوي (الجرعة الثانية)", id: "pcv2" },
            { name: "التطعيم ضد فيروس الروتا (الجرعة الثانية)", id: "rota2" }
        ],
        6: [ // 6 شهور
            { name: "التطعيم ضد الدفتيريا والتيتانوس والسعال الديكي (الجرعة الثالثة)", id: "dtp3" },
            { name: "التطعيم ضد شلل الأطفال (الجرعة الثالثة)", id: "polio3" },
            { name: "التطعيم ضد المستدمية لنزلية (الجرعة الاثثة)", id: "hib3" },
            { name: "التطعيم ضد الالتهاب الرئوي (الجرعة الثالثة)", id: "pcv3" },
            { name: "التطعيم ضد فيروس الروتا (الجرعة الثالثة)", id: "rota3" }
        ],
        12: [ // 12 شهر
            { name: "التطعيم ضد الحصبة والنكاف والحصبة الألمانية (الجرعة الأولى)", id: "mmr1" },
            { name: "التطعيم ضد الجدير المائي (الجرع الأولى)", id: "var1" },
            { name: "التطعيم ضد التهاب الكبد A (الجرعة الأوى)", id: "hepa1" },
            { name: "اتطعيم ضد الأنفلونزا", id: "flu1" }
        ],
        18: [ // 18 شهر
            { name: "التطعيم ضد الحصة النكاف والحصبة الألمانية (الجرعة الثانية)", id: "mmr2" },
            { name: "التطعيم ضد الدفتيريا والتيتانوس والسعال الديكي (جرعة تعزيزية)", id: "dtp4" },
            { name: "التطعيم ضد شلل الأطفال (جعة تعزيزية)", id: "polio4" }
        ],
        24: [ // 24 شهر
            { name: "التطعيم ضد الأنفلونزا (إذا كان موسمياً)", id: "flu2" },
            { name: "التطعيم ضد التهاب الكبد A (الجرعة الثانية)", id: "hepa2" }
        ]
            // ... باقي اأعمار والتطعيمات
        };

        // التحقق من وجود جلسة مسجلة
        //window.onload = function() {
        //    const userData = localStorage.getItem('userData');
        //    if (!userData) {
        //        window.location.href = 'login.html';
        //    }
        

        // إضافة متغيرات عامة للتحكم في محاولات التحقق
        let verificationAttempts = 0;
        let blockedIds = new Set(JSON.parse(localStorage.getItem('blockedIds') || '[]'));
        const MAX_ATTEMPTS = 2; // عدد المحاولات المسموحة
        
        // تحديث دالة البحث للتحقق من القائمة السوداء
        async function searchUser() {
            const nationalId = document.getElementById('nationalId').value.trim();
            const searchError = document.getElementById('searchError');
            
            // التحقق من صحة الرقم القومي
            if (!nationalId || nationalId.length !== 14 || !/^\d+$/.test(nationalId)) {
                showError('الرجاء إدخال رقم قومي صحيح مكون من 14 رقم');
                return;
            }
            
            try {
                startLoading();
                
                // الحصول على بيانات الدكتور
                const doctorData = JSON.parse(localStorage.getItem('doctorData'));
                if (!doctorData || !doctorData.nationalId) {
                    throw new Error('لم يتم العثور على بيانات الطبيب');
                }

                // التحقق من قائمة عدم الحظر
                const noBlockRef = firebase.database()
                    .ref(`doctors/${doctorData.nationalId}/noBlockList/${nationalId}`);
                const noBlockSnapshot = await noBlockRef.once('value');
                const noBlockData = noBlockSnapshot.val();

                // التحقق من القائمة السوداء فقط إذا لم يكن في قائمة عدم الحظر أو انتهت صلاحيتها
                if (noBlockData && noBlockData.expiryDate > Date.now()) {
                    // المستخدم في قائمة عدم الحظر وصلاحيته سارية
                    const userRef = firebase.database().ref(`users/${nationalId}`);
                    const snapshot = await userRef.once('value');
                    const userData = snapshot.val();

                    if (!userData) {
                        showError('لم يتم العثور على هذا المستخدم');
                        return;
                    }

                    // عرض البيانات مباشرة بدون تحقق
                    showUserData(userData);
                    showNotification('تم العثور على البيانات', 'success');
                    return;
                }

                // التحقق من القائمة السوداء
                if (blockedIds.has(nationalId)) {
                    showError('عذراً، هذا الرقم القومي محظور من الوصول للبيانات');
                    return;
                }

                // البحث في قاعدة البيانات
                const userRef = firebase.database().ref(`users/${nationalId}`);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();

                if (!userData) {
                    showError('لم يتم العثور على هذا المستخدم');
                    return;
                }

                // إعادة تعيين عداد المحاولات
                verificationAttempts = 0;
                showVerification(userData);

            } catch (error) {
                console.error('خطأ:', error);
                showError('حدث خطأ في البحث');
            } finally {
                stopLoading();
            }
        }

        function startLoading() {
            const searchButton = document.getElementById('searchButton');
            const buttonText = searchButton.querySelector('.button-text');
            const loadingSpan = searchButton.querySelector('.loading');
            
            searchButton.classList.add('loading-state');
            buttonText.style.opacity = '0';
            loadingSpan.style.display = 'flex';
            searchButton.disabled = true;
        }

        function stopLoading() {
            const searchButton = document.getElementById('searchButton');
            const buttonText = searchButton.querySelector('.button-text');
            const loadingSpan = searchButton.querySelector('.loading');
            
            loadingSpan.style.display = 'none';
            buttonText.style.opacity = '1';
            searchButton.classList.remove('loading-state');
            searchButton.disabled = false;
        }

        function showSuccess() {
            const searchButton = document.getElementById('searchButton');
            const buttonText = searchButton.querySelector('.button-text');
            const loadingSpan = searchButton.querySelector('.loading');
            
            loadingSpan.style.display = 'none';
            buttonText.style.opacity = '1';
            searchButton.classList.remove('loading-state');
            searchButton.disabled = false;
        }

        function showError(message) {
            const errorMessage = document.getElementById('searchError');
            const searchButton = document.getElementById('searchButton');
            
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            searchButton.classList.remove('loading-state');
            searchButton.disabled = false;

            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 3000);
        }

        async function loadUpcomingVaccines(nationalId, birthDate) {
            const container = document.getElementById('upcomingVaccines');
            container.innerHTML = '';

            try {
                // جلب التطعيمات المكتملة
                const completedRef = firebase.database().ref(`users/${nationalId}/vaccines`);
                const completedSnapshot = await completedRef.once('value');
                const completedVaccines = completedSnapshot.val() || {};

                // حساب عمر الطفل بالأشهر
                const birthDateTime = new Date(birthDate).getTime();
                const currentTime = new Date().getTime();
                const ageInMonths = Math.floor((currentTime - birthDateTime) / (30 * 24 * 60 * 60 * 1000));

                // عرض التطعيمات المناسبة للعمر
                Object.entries(vaccineSchedule).forEach(([months, vaccines]) => {
                    const monthsNum = parseInt(months);
                    if (monthsNum >= ageInMonths - 1 && monthsNum <= ageInMonths + 2) {
                        vaccines.forEach(vaccine => {
                            if (!completedVaccines[vaccine.id]) {
                                const card = createVaccineCard(vaccine, nationalId, monthsNum);
                                container.appendChild(card);
                            }
                        });
                    }
                });

                if (container.children.length === 0) {
                    container.innerHTML = '<p>لا توجد تطعيمات مستحقة حالياً</p>';
                }

            } catch (error) {
                console.error('خطأ في تحميل التطعيمات:', error);
                showNotification('حدث خطأ في تحميل التطعيمات', 'error');
            }
        }

        function createVaccineCard(vaccine, nationalId, months) {
            const card = document.createElement('div');
            card.className = 'vaccine-card';
            card.setAttribute('data-vaccine-id', vaccine.id);
            
            card.innerHTML = `
                <div class="vaccine-info">
                    <h3>${vaccine.name}</h3>
                    <div class="vaccine-date">
                        <i class="far fa-calendar-alt"></i>
                        العمر المطلوب: ${months} شهر
                    </div>
                </div>
                <button class="confirm-btn" onclick="confirmVaccine('${vaccine.id}', '${nationalId}')">
                    <i class="fas fa-syringe"></i>
                    تأكيد التطعيم
                </button>
            `;
            return card;
        }

        async function confirmVaccine(vaccineId, nationalId) {
            try {
                // الحصول على بيانات الدكتور
                const doctorData = JSON.parse(localStorage.getItem('doctorData'));
                if (!doctorData) {
                    throw new Error('لم يتم العثور على بيانات الطبيب');
                }

                // إنشاء كائن بيانات التطعيم مع معلومات الدكتور
                const vaccineData = {
                    status: 'completed',
                    date: firebase.database.ServerValue.TIMESTAMP,
                    doctor: {
                        name: doctorData.name,
                        nationalId: doctorData.nationalId,
                        specialty: doctorData.specialty,
                        hospital: doctorData.hospital
                    }
                };

                // حفظ البيانات في Firebase
                await firebase.database()
                    .ref(`users/${nationalId}/vaccines/${vaccineId}`)
                    .set(vaccineData);

                const card = document.querySelector(`[data-vaccine-id="${vaccineId}"]`);
                if (card) {
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 300);
                }

                showNotification('تم تسجيل التطعيم بنجاح', 'success');

                // إعادة تحميل التطعيمات المتبقية
                const userData = (await firebase.database().ref(`users/${nationalId}`).once('value')).val();
                await loadUpcomingVaccines(nationalId, userData.birthdate);

            } catch (error) {
                console.error('خطأ في تأكيد التطعيم:', error);
                showNotification('حدث خطأ في تسجيل التطعيم', 'error');
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // تحديث مجموعة الأسئلة
        const verificationQuestions = {
            age: (userData) => {
                const age = calculateAge(new Date(userData.birthdate));
                return {
                    question: `ما هو عمر المريض ${userData.name}؟`,
                    options: generateAgeOptions(age).map(opt => ({ 
                        text: `${opt} سنة`,
                        value: opt
                    })),
                    correct: age
                };
            },

            birthMonth: (userData) => {
                const birthDate = new Date(userData.birthdate);
                const months = [
                    'يناير', 'فبراير', 'مارس', 'إبريل', 'مايو', 'يونيو',
                    'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
                ];
                const correctMonth = birthDate.getMonth();
                return {
                    question: `في أي شهر ولد المريض ${userData.name}`,
                    options: generateMonthOptions(correctMonth, months).map(opt => ({
                        text: months[opt],
                        value: opt
                    })),
                    correct: correctMonth
                };
            },

            birthYear: (userData) => {
                const birthYear = new Date(userData.birthdate).getFullYear();
                return {
                    question: `في أي سنة ولد المريض ${userData.name}؟`,
                    options: generateYearOptions(birthYear).map(opt => ({
                        text: opt.toString(),
                        value: opt
                    })),
                    correct: birthYear
                };
            },

            birthDay: (userData) => {
                const birthDate = new Date(userData.birthdate);
                const day = birthDate.getDate();
                return {
                    question: `في أي يوم من الشهر ولد المريض ${userData.name}؟`,
                    options: generateDayOptions(day).map(opt => ({
                        text: opt.toString(),
                        value: opt
                    })),
                    correct: day
                };
            },

            phoneLastDigits: (userData) => {
                const lastFourDigits = userData.phone.slice(-4);
                return {
                    question: `ما هي آخر 4 أرقام من رقم هاتف المريض ${userData.name}؟`,
                    options: generatePhoneOptions(lastFourDigits).map(opt => ({
                        text: opt,
                        value: opt
                    })),
                    correct: lastFourDigits
                };
            },

            emailDomain: (userData) => {
                const emailDomain = userData.email.split('@')[1];
                return {
                    question: `ما هو نطاق البريد الإلكتروني للمريض ${userData.name}؟`,
                    options: generateEmailOptions(emailDomain).map(opt => ({
                        text: '@' + opt,
                        value: opt
                    })),
                    correct: emailDomain
                };
            },

            phonePrefix: (userData) => {
                const prefix = userData.phone.slice(0, 3);
                return {
                    question: `ما هي شبكة الهاتف المحمول للمريض ${userData.name}؟`,
                    options: [
                        { text: 'اتصاات (011)', value: '011' },
                        { text: 'فودافون (010)', value: '010' },
                        { text: 'اورانج (012)', value: '012' },
                        { text: 'وي (015)', value: '015' }
                    ],
                    correct: prefix
                };
            },

            emailPrefix: (userData) => {
                const emailPrefix = userData.email.split('@')[0];
                return {
                    question: `ما هو اسم المستخدم في البريد الإلكتروني للمريض ${userData.name}؟`,
                    options: generateEmailPrefixOptions(emailPrefix).map(opt => ({
                        text: opt,
                        value: opt
                    })),
                    correct: emailPrefix
                };
            }
        };

        // دوال مساعدة جديدة لتوليد الخيارات
        function generatePhoneOptions(correctDigits) {
            const options = [correctDigits];
            while (options.length < 3) {
                let randomDigits = '';
                for (let i = 0; i < 4; i++) {
                    randomDigits += Math.floor(Math.random() * 10);
                }
                if (!options.includes(randomDigits)) {
                    options.push(randomDigits);
                }
            }
            return options.sort(() => Math.random() - 0.5);
        }

        function generateEmailOptions(correctDomain) {
            const commonDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com'];
            const options = [correctDomain];
            const availableDomains = commonDomains.filter(d => d !== correctDomain);
            
            while (options.length < 3) {
                const randomDomain = availableDomains[Math.floor(Math.random() * availableDomains.length)];
                if (!options.includes(randomDomain)) {
                    options.push(randomDomain);
                }
            }
            return options.sort(() => Math.random() - 0.5);
        }

        function generateEmailPrefixOptions(correctPrefix) {
            const options = [correctPrefix];
            while (options.length < 3) {
                let randomPrefix = correctPrefix;
                // تغيير حرف عشوائي أو إضافة رقم
                if (Math.random() > 0.5) {
                    const pos = Math.floor(Math.random() * randomPrefix.length);
                    randomPrefix = randomPrefix.substring(0, pos) + 
                                  Math.floor(Math.random() * 10) + 
                                  randomPrefix.substring(pos + 1);
                } else {
                    randomPrefix += Math.floor(Math.random() * 100);
                }
                if (!options.includes(randomPrefix)) {
                    options.push(randomPrefix);
                }
            }
            return options.sort(() => Math.random() - 0.5);
        }

        // تديث دالة رض التحقق لاختيار سؤالين عشوائيين
        function showVerification(userData) {
            const verificationSection = document.getElementById('verificationSection');
            const questionText = document.getElementById('verificationQuestion');
            const optionsContainer = document.getElementById('optionsContainer');

            // اختيار سؤالين عشوائيين مختلفين
            const questionTypes = Object.keys(verificationQuestions);
            const randomTypes = questionTypes.sort(() => Math.random() - 0.5).slice(0, 2);
            const currentQuestionType = randomTypes[verificationAttempts];
            const questionData = verificationQuestions[currentQuestionType](userData);

            questionText.textContent = questionData.question;
            optionsContainer.innerHTML = '';
            
            questionData.options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = option.text;
                button.onclick = () => verifyAnswer(option.value, questionData.correct, userData, currentQuestionType);
                optionsContainer.appendChild(button);
            });

            verificationSection.style.display = 'flex';
        }

        // تحديث دالة التحقق من الإجابة
        function verifyAnswer(selectedValue, correctValue, userData, questionType) {
            const verificationSection = document.getElementById('verificationSection');
            const errorElement = document.getElementById('verificationError');
            
            if (selectedValue === correctValue) {
                if (verificationAttempts === 0) {
                    verificationAttempts++;
                    showVerification(userData);
                    showNotification('إجابة صحيحة! السؤال التالي', 'success');
                } else {
                    // إذا نجح في التحقق، نرسل إشعاراً للمستخدم
                    sendAccessNotification(userData);
                    verificationSection.style.display = 'none';
                    showUserData(userData);
                    showNotification('تم التحقق بنجاح', 'success');
                }
            } else {
                verificationAttempts++;
                if (verificationAttempts >= MAX_ATTEMPTS) {
                    blockUser(userData.nationalId);
                    verificationSection.style.display = 'none';
                    showError('تم حظر الوصول لهذا الرقم القومي بسبب فشل التحقق');
                } else {
                    errorElement.textContent = 'إجابة خاطئة، حاول مرة أخرى';
                    errorElement.style.display = 'block';
                }
            }
        }

        // إضافة دالة جديدة لإرسال الإشعار
        async function sendAccessNotification(userData) {
            try {
                const doctorData = JSON.parse(localStorage.getItem('doctorData'));
                if (!doctorData) {
                    throw new Error('لم يتم العثور على بيانات الطبيب');
                }

                // إنشاء كائن الإشعار
                const notification = {
                    type: 'access_alert',
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    doctor: {
                        name: doctorData.name,
                        specialty: doctorData.specialty,
                        hospital: doctorData.hospital,
                        nationalId: doctorData.nationalId
                    },
                    message: `تم الوصول إلى بياناتك الطبية من قبل الدكتور ${doctorData.name} (${doctorData.specialty}) من ${doctorData.hospital}`,
                    status: 'unread'
                };

                // حفظ الإشعار في Firebase
                await firebase.database()
                    .ref(`users/${userData.nationalId}/notifications`)
                    .push(notification);

                // إرسال بريد إلكتروني للمستخدم (اختياري)
                const emailParams = {
                    to_email: userData.email,
                    to_name: userData.name,
                    doctor_name: doctorData.name,
                    doctor_specialty: doctorData.specialty,
                    hospital_name: doctorData.hospital,
                    access_time: new Date().toLocaleString('ar-EG')
                };

                emailjs.send('service_4xzeqtf', 'template_0ryvd69', emailParams)
                    .then(
                        function(response) {
                            console.log("تم إرسال البريد الإلكتروني بنجاح", response);
                        },
                        function(error) {
                            console.error("خطأ في إرسال البريد الإلكتروني:", error);
                        }
                    );

            } catch (error) {
                console.error('خطأ في إرسال الإشعار:', error);
                showNotification('تم الوصول للبيانات ولكن حدث خطأ في إرسال الإشعار', 'warning');
            }
        }

        // دالة إنشاء خيارات الشهور
        function generateMonthOptions(correctMonth, months) {
            const options = [correctMonth];
            while (options.length < 3) {
                const randomMonth = Math.floor(Math.random() * 12);
                if (!options.includes(randomMonth)) {
                    options.push(randomMonth);
                }
            }
            return options.sort(() => Math.random() - 0.5);
        }

        // دالة عرض بيانات المستخدم
        function showUserData(userData) {
            document.querySelector('#userName span').textContent = userData.name;
            document.querySelector('#userBirthDate span').textContent = formatDate(userData.birthdate);
            document.getElementById('vaccinesSection').style.display = 'block';
            loadUpcomingVaccines(userData.nationalId, userData.birthdate);
        }

        // تحسين دالة إظهار الخطأ
        function showError(message) {
            const errorMessage = document.getElementById('searchError');
            const searchButton = document.getElementById('searchButton');
            
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            searchButton.classList.remove('loading-state');
            searchButton.disabled = false;

            // إضافة تأثير الاهتزاز
            errorMessage.classList.add('shake');
            setTimeout(() => {
                errorMessage.classList.remove('shake');
            }, 500);

            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 4000);
        }

        // إضافة نمط للاهتزاز
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }

            .shake {
                animation: shake 0.5s ease-in-out;
            }
        `;
        document.head.appendChild(style);

        // دالة حساب العمر
        function calculateAge(birthDate) {
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // دالة إنشاء خيارات عشوائية للعمر
        function generateAgeOptions(correctAge) {
            const options = [correctAge];
            
            while (options.length < 3) {
                const randomAge = correctAge + Math.floor(Math.random() * 5) - 2; // عمر عشوائي ±2 سنة
                if (randomAge > 0 && !options.includes(randomAge)) {
                    options.push(randomAge);
                }
            }
            
            // ترتيب الخيارات عشوائياً
            return options.sort(() => Math.random() - 0.5);
        }

        // متغيرات عامة
        let selectedBlockedUser = null;

        // دالة عرض/إخفاء قائمة المحظورين
        function toggleBlockedUsers() {
            const container = document.getElementById('blockedUsersContainer');
            if (container.style.display === 'none') {
                loadBlockedUsers();
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // دالة تحميل المستخدمين لمحظورين
        async function loadBlockedUsers() {
            const blockedUsersList = document.getElementById('blockedUsersList');
            blockedUsersList.innerHTML = '<p>جاري تحميل البيانات...</p>';

            try {
                const doctorData = JSON.parse(localStorage.getItem('doctorData'));
                if (!doctorData || !doctorData.nationalId) {
                    throw new Error('لم يتم العثور على بيانات الطبيب');
                }

                // جلب المحظورين من Firebase
                const blockedRef = firebase.database()
                    .ref(`doctors/${doctorData.nationalId}/blockedUsers`);
                const snapshot = await blockedRef.once('value');
                const serverBlockedUsers = snapshot.val() || {};

                // تحديث القائمة المحلية
                blockedIds = new Set(Object.keys(serverBlockedUsers));
                localStorage.setItem('blockedIds', JSON.stringify([...blockedIds]));

                // عرض المحظورين
                blockedUsersList.innerHTML = '';
                for (const id of blockedIds) {
                    const userRef = firebase.database().ref(`users/${id}`);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val();

                    if (userData) {
                        const card = createBlockedUserCard(userData);
                        blockedUsersList.appendChild(card);
                    }
                }

                if (blockedUsersList.children.length === 0) {
                    blockedUsersList.innerHTML = '<p>لا يوجد مستخدمين محظورين</p>';
                }

            } catch (error) {
                console.error('خطأ في تحميل المستخدمين المحظورين:', error);
                showNotification('حدث خطأ في تحميل البيانات', 'error');
                blockedUsersList.innerHTML = '<p>حدث خطأ في تحميل البيانات</p>';
            }
        }

        // دالة إنشاء بطاقة المستخدم المحظور
        function createBlockedUserCard(userData) {
            const card = document.createElement('div');
            card.className = 'blocked-user-card';
            
            card.innerHTML = `
                <div class="blocked-user-info">
                    <span class="blocked-user-name">${userData.name}</span>
                    <span class="blocked-user-id">الرقم القومي: ${userData.nationalId}</span>
                </div>
                <button onclick="showRequestModal('${userData.nationalId}')" class="request-access-btn">
                    <i class="fas fa-envelope"></i>
                    طلب إعادة الوصول
                </button>
            `;
            
            return card;
        }

        // دالة عرض نافذة طلب إعادة الوصول
        function showRequestModal(nationalId) {
            selectedBlockedUser = nationalId;
            document.getElementById('requestAccessModal').style.display = 'flex';
        }

        // دالة إغلاق نافذة الطلب
        function closeRequestModal() {
            document.getElementById('requestAccessModal').style.display = 'none';
            document.getElementById('requestMessage').value = '';
            selectedBlockedUser = null;
        }

        // تحديث دالة إرسال طلب إعادة الوصول
        async function sendAccessRequest() {
            if (!selectedBlockedUser) {
                console.error('لم يتم اختيار مستخدم');
                return;
            }

            try {
                const sendButton = document.querySelector('.send-request-btn');
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
                sendButton.disabled = true;

                // الحصول على بيانات الطبيب من التخزين المحلي
                const doctorData = JSON.parse(localStorage.getItem('doctorData'));
                if (!doctorData) {
                    throw new Error('لم يتم العثور على بيانات الطبيب');
                }

                const message = document.getElementById('requestMessage').value || 'تم تقديم طلب لإعادة الوصول إلى البيانات الطبية.';
                
                // إنشاء كائن البيانات للحفظ مع معلومات الطبيب
                const requestData = {
                    message: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'pending',
                    doctor: {
                        name: doctorData.name,
                        nationalId: doctorData.nationalId,
                        email: doctorData.email,
                        specialty: doctorData.specialty,
                        hospital: doctorData.hospital
                    }
                };

                // حفظ الطلب في Firebase
                await firebase.database()
                    .ref(`users/${selectedBlockedUser}/accessRequests`)
                    .push(requestData);

                showNotification('تم إرسال طلب إعادة الوصول بنجاح', 'success');
                closeRequestModal();

            } catch (error) {
                console.error('خطأ في حفظ الطلب:', error);
                showNotification('حدث خطأ في إرسال الطلب', 'error');
            } finally {
                const sendButton = document.querySelector('.send-request-btn');
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> إرسال الطلب';
                sendButton.disabled = false;
            }
        }

        // تحسين دالة إظهار الإشعارات
        function showNotification(message, type = 'info') {
            // إزالة أي إشعارات سابقة
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            // إضافة تأثير الظهور
            setTimeout(() => notification.classList.add('show'), 100);

            // إزالة الإشعار بعد 3 ثواني
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // تحديث دالة تحميل بيانات الطبيب
        async function loadDoctorData() {
            try {
                // عرض البيانات المحلية أولاً للسرعة
                const localDoctorData = JSON.parse(localStorage.getItem('doctorData'));
                if (!localDoctorData || !localDoctorData.nationalId) {
                    window.location.href = 'doctor-sign.html';
                    return;
                }
                
                // عرض البيانات امحلية فوراً
                displayDoctorInfo(localDoctorData);

                // جلب بيانات الطبيب من Firebase
                const doctorRef = firebase.database().ref(`doctors/${localDoctorData.nationalId}`);
                const snapshot = await doctorRef.once('value');
                const serverDoctorData = snapshot.val();

                if (!serverDoctorData) {
                    throw new Error('لم يتم العثور على بيانات الطبيب في السيرفر');
                }

                // مقارنة وتحديث البيانات المحلية إذا كانت مختلفة
                if (JSON.stringify(localDoctorData) !== JSON.stringify(serverDoctorData)) {
                    localStorage.setItem('doctorData', JSON.stringify(serverDoctorData));
                    displayDoctorInfo(serverDoctorData); // تحديث العرض
                }

                // جلب قائمة المحظورين من السيرفر
                const blockedRef = firebase.database().ref(`doctors/${localDoctorData.nationalId}/blockedUsers`);
                const blockedSnapshot = await blockedRef.once('value');
                const serverBlockedIds = blockedSnapshot.val() || {};

                // جلب المحظوري المحليين
                const localBlockedIds = new Set(JSON.parse(localStorage.getItem('blockedIds') || '[]'));

                // تحديث قائمة المحظورين المحلية من السيرفر
                const updatedBlockedIds = new Set([...Object.keys(serverBlockedIds)]);
                
                // تحديث التخزين المحلي إذا كان هناك اختلاف
                if (JSON.stringify([...localBlockedIds]) !== JSON.stringify([...updatedBlockedIds])) {
                    localStorage.setItem('blockedIds', JSON.stringify([...updatedBlockedIds]));
                    blockedIds = updatedBlockedIds; // تحديث المتغير العام
                }

            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                showNotification('حدث خطأ في تحميل البيانات', 'error');
            }
        }

        // تحديث دالة حظر المستخدم
        async function blockUser(nationalId) {
            try {
                const doctorData = JSON.parse(localStorage.getItem('doctorData'));
                if (!doctorData || !doctorData.nationalId) {
                    throw new Error('لم يتم العثور على بيانات اطبيب');
                }

                // إضافة المستخدم للمحظورين في Firebase أولاً
                await firebase.database()
                    .ref(`doctors/${doctorData.nationalId}/blockedUsers/${nationalId}`)
                    .set({
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        status: 'blocked'
                    });

                // بعد نجاح الإضافة في Firebase، نقوم بالتحديث محلياً
                blockedIds.add(nationalId);
                localStorage.setItem('blockedIds', JSON.stringify([...blockedIds]));

                showNotification('تم حظر المستخدم بنجاح', 'success');
                
                // تحديث عرض المحظورين
                await loadBlockedUsers();
                
            } catch (error) {
                console.error('خطأ في حظر المستخدم:', error);
                showNotification('حدث خطأ في حظر المستخدم', 'error');
            }
        }

        // دالة عرض بيانات الطبيب في الصفحة
        function displayDoctorInfo(doctorData) {
            // إزالة أي قسم معلومات طبيب موجود مسبقاً
            const existingInfo = document.querySelector('.doctor-info-section');
            if (existingInfo) {
                existingInfo.remove();
            }

            // إضافة قسم معلومات الطبيب في أعلى الصفحة
            const container = document.querySelector('.container');
            const doctorInfo = document.createElement('div');
            doctorInfo.className = 'doctor-info-section';
            doctorInfo.innerHTML = `
                <div class="doctor-header">
                    <div class="doctor-avatar">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div class="doctor-details">
                        <h2>د. ${doctorData.name}</h2>
                        <p class="specialty">${doctorData.specialty}</p>
                        <p class="hospital">${doctorData.hospital}</p>
                    </div>
                </div>
            `;

            // إضافة القسم في بداية الصفحة
            container.insertBefore(doctorInfo, container.firstChild);

            // إافة الأنماط الخاصة بقسم معلومات الطبيب
            const style = document.createElement('style');
            style.textContent = `
                .doctor-info-section {
                    background: white;
                    padding: 20px;
                    border-radius: 20px;
                    box-shadow: var(--card-shadow);
                    margin-bottom: 20px;
                    transition: transform 0.3s ease;
                }

                .doctor-info-section:hover {
                    transform: translateY(-5px);
                }

                .doctor-header {
                    display: flex;
                    align-items: center;
                    gap: 20px;
                }

                .doctor-avatar {
                    width: 80px;
                    height: 80px;
                    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

                .doctor-avatar i {
                    font-size: 2.5em;
                    color: white;
                }

                .doctor-details {
                    flex: 1;
                }

                .doctor-details h2 {
                    margin: 0;
                    color: var(--primary-color);
                    font-size: 1.5em;
                }

                .doctor-details .specialty {
                    color: var(--secondary-color);
                    font-weight: 600;
                    margin: 5px 0;
                }

                .doctor-details .hospital {
                    color: #666;
                    font-size: 0.9em;
                }
            `;
            document.head.appendChild(style);
        }

        function checkAuth() {
            const doctorData = JSON.parse(localStorage.getItem('doctorData'));
            if (!doctorData || !doctorData.nationalId) {
                window.location.href = 'doctor-sign.html';
                return false;
            }
            return true;
        }

        // إضافة دالة لتنظيف قائمة عدم الحظر المنتهية الصلاحية
        async function cleanupExpiredNoBlockList() {
            try {
                const doctorData = JSON.parse(localStorage.getItem('doctorData'));
                if (!doctorData || !doctorData.nationalId) return;

                const noBlockRef = firebase.database()
                    .ref(`doctors/${doctorData.nationalId}/noBlockList`);
                const snapshot = await noBlockRef.once('value');
                const noBlockList = snapshot.val() || {};

                const currentTime = Date.now();
                const updates = {};

                // تحديد العناصر المنتهية الصلاحية
                Object.entries(noBlockList).forEach(([userId, data]) => {
                    if (data.expiryDate <= currentTime) {
                        updates[userId] = null; // حذف العنصر
                    }
                });

                // تطبيق التحديثات إذا وجدت
                if (Object.keys(updates).length > 0) {
                    await noBlockRef.update(updates);
                }
            } catch (error) {
                console.error('خطأ في تنظيف قائمة عدم الحظر:', error);
            }
        }

        // تحديث window.onload
        window.onload = async function() {
            if (!checkAuth()) return;
            await loadDoctorData();
            await cleanupExpiredNoBlockList(); // تنظيف القائمة عند تحميل الصفحة
        };
    </script>
</body>
</html> 